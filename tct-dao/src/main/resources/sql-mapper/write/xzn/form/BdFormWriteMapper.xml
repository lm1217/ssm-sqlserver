<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.iyeed.dao.db.write.xzn.form.BdFormWriteDao">
	<resultMap id="BdFormResult" type="com.iyeed.core.entity.form.BdForm">
			<result property="id" column="id" />
			<result property="storeNo" column="store_no" />
			<result property="storeName" column="store_name" />
			<result property="applyNo" column="apply_no" />
			<result property="applicant" column="applicant" />
			<result property="applicantTel" column="applicant_tel" />
			<result property="remark" column="remark" />
			<result property="applyDate" column="apply_date" />
			<result property="destroyType" column="destroy_type" />
			<result property="receiveStoreNo" column="receive_store_no" />
			<result property="receiveStoreName" column="receive_store_name" />
			<result property="expressCode" column="express_code" />
			<result property="expressName" column="express_name" />
			<result property="orderNo" column="order_no" />
			<result property="expressDate" column="express_date" />
			<result property="allotType" column="allot_type" />
			<result property="exceptionType" column="exception_type" />
			<result property="formType" column="form_type" />
			<result property="disposeUserNo" column="dispose_user_no" />
			<result property="disposeStatus" column="dispose_status" />
			<result property="disposeStatusDesc" column="dispose_status_desc" />
			<result property="disposeGrade" column="dispose_grade" />
			<result property="inputDate" column="input_date" />
			<result property="applyUserNo" column="apply_user_no" />
			<result property="updateDate" column="update_date" />
			<result property="sendMailDate" column="send_mail_date" />
			<result property="isBack" column="is_back" />
			<result property="brandNo" column="brand_no" />
	</resultMap>

	<resultMap id="GetDisposeFormListBeanResult" type="com.iyeed.core.entity.form.vo.GetDisposeFormListBean">
		<result property="id" column="id" />
		<result property="storeNo" column="store_no" />
		<result property="storeName" column="store_name" />
		<result property="applyNo" column="apply_no" />
		<result property="applyDate" column="apply_date" />
		<result property="formType" column="form_type" />
		<result property="disposeStatus" column="dispose_status" />
		<result property="disposeStatusDesc" column="dispose_status_desc" />
		<result property="inputDate" column="input_date" />
		<result property="isBack" column="is_back" />
		<result property="applyUserNo" column="apply_user_no" />
	</resultMap>

	<resultMap id="FormJobBeanResult" type="com.iyeed.core.entity.form.vo.FormJobBean">
		<result property="id" column="id" />
		<result property="storeNo" column="store_no" />
		<result property="storeName" column="store_name" />
		<result property="brandNo" column="brand_no" />
		<result property="brandName" column="brand_name" />
		<result property="applyNo" column="apply_no" />
		<result property="formType" column="form_type" />
		<result property="disposeUserNo" column="dispose_user_no" />
		<result property="disposeStatus" column="dispose_status" />
		<result property="disposeGrade" column="dispose_grade" />
		<result property="destroyType" column="destroy_type" />
		<result property="userEmail" column="user_email" />
		<result property="isBack" column="is_back" />
	</resultMap>

	<resultMap id="ExceptionReportBeanResult" type="com.iyeed.core.entity.form.vo.ExceptionReportBean">
		<result property="id" column="id" />
		<result property="storeNo" column="store_no" />
		<result property="storeName" column="store_name" />
		<result property="applyNo" column="apply_no" />
		<result property="applyDate" column="apply_date" />
		<result property="exceptionType" column="exception_type" />
		<result property="disposeStatus" column="dispose_status" />
		<result property="brandName" column="brand_name" />
		<result property="skuCode" column="sku_code" />
		<result property="skuName" column="sku_name" />
		<result property="changeType" column="change_type" />
		<result property="changeTotal" column="change_total" />
	</resultMap>

	<resultMap id="GetDestroyFormListBeanResult" type="com.iyeed.core.entity.form.vo.GetDestroyFormListBean">
		<result property="brandName" column="brand_name" />
		<result property="storeId" column="store_id" />
		<result property="storeNo" column="store_no" />
		<result property="storeName" column="store_name" />
		<result property="storeAttr" column="store_attr" />
		<result property="skuCode" column="sku_code" />
		<result property="skuName" column="sku_name" />
		<result property="qtl" column="qtl" />
		<result property="cytdQtl" column="cytdQtl" />
		<result property="fytdQtl" column="fytdQtl" />
		<result property="hz" column="hz" />
		<result property="cytdHz" column="cytdHz" />
		<result property="fytdHz" column="fytdHz" />
		<result property="region" column="region" />
		<result property="city" column="city" />
		<result property="channel" column="channel" />
		<result property="doorType" column="door_type" />
		<result property="asm" column="asm" />
		<result property="ac" column="ac" />
	</resultMap>

    <resultMap id="GetDestroyTheftFormListBeanResult" type="com.iyeed.core.entity.form.vo.GetDestroyTheftFormListBean">
		<result property="brandName" column="brand_name" />
		<result property="storeId" column="store_id" />
		<result property="storeNo" column="store_no" />
        <result property="storeName" column="store_name" />
		<result property="storeAttr" column="store_attr" />
		<result property="skuCode" column="sku_code" />
		<result property="skuName" column="sku_name" />
        <result property="qtl" column="qtl" />
		<result property="stockQtl" column="stockQtl" />
		<result property="cytdQtl" column="cytdQtl" />
		<result property="cytdStockQtl" column="cytdStockQtl" />
		<result property="fytdQtl" column="fytdQtl" />
		<result property="fytdStockQtl" column="fytdStockQtl" />
		<result property="rate" column="rate" />
		<result property="cytdRate" column="cytdRate" />
		<result property="fytdRate" column="fytdRate" />
        <result property="region" column="region" />
        <result property="city" column="city" />
		<result property="channel" column="channel" />
        <result property="doorType" column="door_type" />
		<result property="asm" column="asm" />
        <result property="ac" column="ac" />
    </resultMap>

	<resultMap id="GetDSIFormListBeanResult" type="com.iyeed.core.entity.form.vo.GetDSIFormListBean">
		<result property="brandName" column="brand_name" />
		<result property="applyNo" column="apply_no" />
		<result property="storeId" column="store_id" />
		<result property="storeNo" column="store_no" />
		<result property="storeName" column="store_name" />
		<result property="storeAttr" column="store_attr" />
		<result property="skuCode" column="sku_code" />
		<result property="skuName" column="sku_name" />
		<result property="qtl" column="qtl" />
		<result property="dsi" column="dsi" />
		<result property="region" column="region" />
		<result property="city" column="city" />
		<result property="channel" column="channel" />
		<result property="doorType" column="door_type" />
		<result property="asm" column="asm" />
		<result property="ac" column="ac" />
	</resultMap>

	<resultMap id="StockReportBeanResult" type="com.iyeed.core.entity.form.vo.StockReportBean">
		<result property="storeNo" column="user_no" />
		<result property="shDc" column="e_act_send_total" />
		<result property="shDb" column="d_act_send_total" />
		<result property="wshDc" column="c_send_total" />
		<result property="wshDb" column="b_send_total" />
		<result property="xhZc" column="f_change_total" />
		<result property="xhPs" column="g_change_total" />
		<result property="xhGq" column="h_change_total" />
		<result property="xhSq" column="i_change_total" />
		<result property="allot" column="j_change_total" />
		<result property="exceptionA" column="k_change_total" />
		<result property="exceptionB" column="l_change_total" />
		<result property="stockStart" column="stock_total_a" />
		<result property="stockEnd" column="stock_total" />
		<result property="region" column="region" />
		<result property="city" column="city" />
		<result property="channel" column="channel" />
		<result property="doorType" column="door_type" />
		<result property="asm" column="asm" />
		<result property="ac" column="ac" />
	</resultMap>

	<select id="get" parameterType="Integer" resultMap="BdFormResult">
		select
		   *
		from bd_form
		where id = #{id}
	</select>

	<select id="getByApplyNo" parameterType="String" resultMap="BdFormResult">
		select
		   *
		from bd_form
		where apply_no = #{applyNo}
	</select>

	<select id="getBdFormList" parameterType="java.util.Map" resultMap="GetDisposeFormListBeanResult">
		SELECT
		bf.*
		FROM bd_form bf, md_store ms
		<include refid="getCondition"/>
		order by bf.input_date desc
		<if test="size != null and size &gt; 0">offset #{start} row fetch next #{size} row only</if>
	</select>

	<select id="getBdFormListCount" parameterType="java.util.Map" resultType="Integer">
		SELECT count(1)
		FROM bd_form bf, md_store ms
		<include refid="getCondition"/>
	</select>

	<select id="getBdFormListForSendFormMail" parameterType="java.util.Map" resultMap="FormJobBeanResult">
		SELECT
		bf.*, mu.user_email, ms.brand_name, ms.brand_no
		FROM bd_form bf, md_user mu, md_store ms
		WHERE bf.dispose_user_no = mu.user_no and bf.store_no = ms.store_no
		and datediff(dd, bf.send_mail_date, getdate()) > 3
		and bf.dispose_status != 0 and bf.dispose_result = 0 and bf.form_type != 2
		union
		SELECT
		bf.*, mu.user_email, ms.brand_name, ms.brand_no
		FROM bd_form bf, md_user mu, md_store ms
		WHERE bf.dispose_user_no = mu.user_no and bf.store_no = ms.store_no
		and datediff(dd, bf.send_mail_date, getdate()) > 3
		and bf.dispose_status != 0 and bf.dispose_result = 0 and bf.form_type = 2 and bf.dispose_grade > 0
	</select>

	<select id="getBdFormListForDestroySendFormMail" parameterType="java.util.Map" resultMap="FormJobBeanResult">
		SELECT
		bf.*, mu.user_email, ms.brand_name, ms.brand_no
		FROM bd_form bf, md_user mu, md_store ms
		WHERE bf.dispose_user_no = mu.user_no and bf.store_no = ms.store_no
		and datediff(dd, bf.send_mail_date, getdate()) > 7
		and bf.dispose_status != 0 and bf.dispose_result = 0 and bf.form_type = 2
		and bf.dispose_grade = 0
	</select>

	<select id="getBdFormListForChangeAudit" parameterType="java.util.Map" resultMap="FormJobBeanResult">
		SELECT
		bf.*, mu.user_email, ms.brand_name, ms.brand_no
		FROM bd_form bf, md_user mu, md_store ms
		WHERE bf.dispose_user_no = mu.user_no and bf.store_no = ms.store_no
		and datediff(dd, bf.update_date, getdate()) > 7
		and bf.dispose_status != 0 and bf.dispose_result = 0 and bf.form_type != 2
		union
		SELECT
		bf.*, mu.user_email, ms.brand_name, ms.brand_no
		FROM bd_form bf, md_user mu, md_store ms
		WHERE bf.dispose_user_no = mu.user_no and bf.store_no = ms.store_no
		and datediff(dd, bf.update_date, getdate()) > 7
		and bf.dispose_status != 0 and bf.dispose_result = 0 and bf.form_type = 2
		and bf.dispose_grade > 0
	</select>

	<select id="getBdFormListForDestroyChangeAudit" parameterType="java.util.Map" resultMap="FormJobBeanResult">
		SELECT
		bf.*, mu.user_email, ms.brand_name, ms.brand_no
		FROM bd_form bf, md_user mu, md_store ms
		WHERE bf.dispose_user_no = mu.user_no and bf.store_no = ms.store_no
		and datediff(dd, bf.update_date, getdate()) > 45
		and bf.dispose_status != 0 and bf.dispose_result = 0 and bf.form_type = 2
		and bf.dispose_grade = 0
	</select>

	<select id="getDestroyFormList" parameterType="java.util.Map" resultMap="GetDestroyFormListBeanResult">
		select a.*,ms.brand_name,ms.store_name,ms.store_id,
		case when CHARINDEX('MR',a.apply_user_no) > 1 then '美容坊' when CHARINDEX('AR',a.apply_user_no) > 1 then 'Aerin' else '正常店铺' end store_attr,
		ms.region,ms.city,ms.channel,ms.door_type,ms.asm,ms.ac
		from md_store ms,
		(
		select temp.*,cytd.qtl cytdQtl,cytd.hz cytdHz,fytd.qtl fytdQtl,fytd.hz fytdHz  from
		(
		select a.store_no,a.sku_code,a.sku_name,a.apply_user_no,sum(a.qtl) qtl,count(a.update_date) hz
		from
		(
		select bf.store_no,bfs.sku_code,bfs.sku_name,bf.apply_user_no, sum(bfs.change_total) qtl, format(bf.update_date,'yyyy-MM') update_date
		from bd_form bf,bd_form_sku bfs
		where bf.apply_no = bfs.apply_no and bf.form_type = 2 and bf.dispose_status = 0 and bf.dispose_result = 1
		<if test="queryMap.q_starttime != null and queryMap.q_starttime != ''">
			and bf.update_date >= #{queryMap.q_starttime}
		</if>
		<if test="queryMap.q_endtime != null and queryMap.q_endtime != ''">
			and bf.update_date &lt;= #{queryMap.q_endtime}
		</if>
		group by bf.store_no,bfs.sku_code,bfs.sku_name,bf.apply_user_no,format(bf.update_date,'yyyy-MM')
		) a group by a.store_no,a.sku_code,a.sku_name,a.apply_user_no
		) temp
		left join
		-- CYTD
		(
		select a.store_no,a.sku_code,a.apply_user_no,sum(a.qtl) qtl,
		CONCAT(ROUND(COALESCE(CAST(count(a.update_date) AS FLOAT), 0)*100/(datediff(mm,dateadd(yy,datediff(yy,0,getdate()),0),getdate()) + 1), 2),'%') hz
		from
		(
		select bf.store_no,bfs.sku_code,bf.apply_user_no, sum(bfs.change_total) qtl, format(bf.update_date,'yyyy-MM') update_date
		from bd_form bf,bd_form_sku bfs
		where bf.apply_no = bfs.apply_no and bf.form_type = 2 and bf.dispose_status = 0 and bf.dispose_result = 1
		and bf.update_date >= dateadd(yy,datediff(yy,0,getdate()),0)
		and bf.update_date &lt;= getdate()
		group by bf.store_no,bfs.sku_code,bf.apply_user_no,format(bf.update_date,'yyyy-MM')
		) a group by a.store_no,a.sku_code,a.apply_user_no
		) cytd
		on temp.store_no = cytd.store_no and temp.sku_code = cytd.sku_code and temp.apply_user_no = cytd.apply_user_no
		left join
		-- FYTD
		(
		select a.store_no,a.sku_code,a.apply_user_no,sum(a.qtl) qtl,
		CONCAT(ROUND(COALESCE(CAST(count(a.update_date) AS FLOAT), 0)*100/(datediff(mm,(case when datediff(hh, concat(DateName(year,GetDate()),'-07-01 00:00:00'), GetDate()) > 0 then concat(DateName(year,GetDate()),'-07-01 00:00:00') else dateadd(yy, -1, concat(DateName(year,GetDate()),'-07-01 00:00:00')) end),getdate()) + 1), 2),'%') hz
		from
		(
		select bf.store_no,bfs.sku_code,bf.apply_user_no, sum(bfs.change_total) qtl, format(bf.update_date,'yyyy-MM') update_date
		from bd_form bf,bd_form_sku bfs
		where bf.apply_no = bfs.apply_no and bf.form_type = 2 and bf.dispose_status = 0 and bf.dispose_result = 1
		and bf.update_date >=  (case when datediff(hh, concat(DateName(year,GetDate()),'-07-01 00:00:00'), GetDate()) > 0 then concat(DateName(year,GetDate()),'-07-01 00:00:00') else dateadd(yy, -1, concat(DateName(year,GetDate()),'-07-01 00:00:00')) end)
		and bf.update_date &lt;= GetDate()
		group by bf.store_no,bfs.sku_code,bf.apply_user_no,format(bf.update_date,'yyyy-MM')
		) a group by a.store_no,a.sku_code,a.apply_user_no
		) fytd
		on temp.store_no = fytd.store_no and temp.sku_code = fytd.sku_code and temp.apply_user_no = fytd.apply_user_no
		) a
		<include refid="getConditionForDestroy"/>
		order by ms.store_no desc
		<if test="size != null and size &gt; 0">offset #{start} row fetch next #{size} row only</if>
	</select>

	<select id="getDestroyFormListCount" parameterType="java.util.Map" resultType="Integer">
		select count(1)
		from md_store ms,
		(
		select temp.*,cytd.qtl cytdQtl,cytd.hz cytdHz,fytd.qtl fytdQtl,fytd.hz fytdHz  from
		(
		select a.store_no,a.sku_code,a.sku_name,a.apply_user_no,sum(a.qtl) qtl,count(a.update_date) hz
		from
		(
		select bf.store_no,bfs.sku_code,bfs.sku_name,bf.apply_user_no, sum(bfs.change_total) qtl, format(bf.update_date,'yyyy-MM') update_date
		from bd_form bf,bd_form_sku bfs
		where bf.apply_no = bfs.apply_no and bf.form_type = 2 and bf.dispose_status = 0 and bf.dispose_result = 1
		<if test="queryMap.q_starttime != null and queryMap.q_starttime != ''">
			and bf.update_date >= #{queryMap.q_starttime}
		</if>
		<if test="queryMap.q_endtime != null and queryMap.q_endtime != ''">
			and bf.update_date &lt;= #{queryMap.q_endtime}
		</if>
		group by bf.store_no,bfs.sku_code,bfs.sku_name,bf.apply_user_no,format(bf.update_date,'yyyy-MM')
		) a group by a.store_no,a.sku_code,a.sku_name,a.apply_user_no
		) temp
		left join
		-- CYTD
		(
		select a.store_no,a.sku_code,a.apply_user_no,sum(a.qtl) qtl,
		CONCAT(ROUND(COALESCE(CAST(count(a.update_date) AS FLOAT), 0)*100/(datediff(mm,dateadd(yy,datediff(yy,0,getdate()),0),getdate()) + 1), 2),'%') hz
		from
		(
		select bf.store_no,bfs.sku_code,bf.apply_user_no, sum(bfs.change_total) qtl, format(bf.update_date,'yyyy-MM') update_date
		from bd_form bf,bd_form_sku bfs
		where bf.apply_no = bfs.apply_no and bf.form_type = 2 and bf.dispose_status = 0 and bf.dispose_result = 1
		and bf.update_date >= dateadd(yy,datediff(yy,0,getdate()),0)
		and bf.update_date &lt;= getdate()
		group by bf.store_no,bfs.sku_code,bf.apply_user_no,format(bf.update_date,'yyyy-MM')
		) a group by a.store_no,a.sku_code,a.apply_user_no
		) cytd
		on temp.store_no = cytd.store_no and temp.sku_code = cytd.sku_code and temp.apply_user_no = cytd.apply_user_no
		left join
		-- FYTD
		(
		select a.store_no,a.sku_code,a.apply_user_no,sum(a.qtl) qtl,
		CONCAT(ROUND(COALESCE(CAST(count(a.update_date) AS FLOAT), 0)*100/(datediff(mm,(case when datediff(hh, concat(DateName(year,GetDate()),'-07-01 00:00:00'), GetDate()) > 0 then concat(DateName(year,GetDate()),'-07-01 00:00:00') else dateadd(yy, -1, concat(DateName(year,GetDate()),'-07-01 00:00:00')) end),getdate()) + 1), 2),'%') hz
		from
		(
		select bf.store_no,bfs.sku_code,bf.apply_user_no, sum(bfs.change_total) qtl, format(bf.update_date,'yyyy-MM') update_date
		from bd_form bf,bd_form_sku bfs
		where bf.apply_no = bfs.apply_no and bf.form_type = 2 and bf.dispose_status = 0 and bf.dispose_result = 1
		and bf.update_date >=  (case when datediff(hh, concat(DateName(year,GetDate()),'-07-01 00:00:00'), GetDate()) > 0 then concat(DateName(year,GetDate()),'-07-01 00:00:00') else dateadd(yy, -1, concat(DateName(year,GetDate()),'-07-01 00:00:00')) end)
		and bf.update_date &lt;= GetDate()
		group by bf.store_no,bfs.sku_code,bf.apply_user_no,format(bf.update_date,'yyyy-MM')
		) a group by a.store_no,a.sku_code,a.apply_user_no
		) fytd
		on temp.store_no = fytd.store_no and temp.sku_code = fytd.sku_code and temp.apply_user_no = fytd.apply_user_no
		) a
		<include refid="getConditionForDestroy"/>
	</select>

    <select id="getDestroyTheftFormList" parameterType="java.util.Map" resultMap="GetDestroyTheftFormListBeanResult">
		select a.store_no,a.sku_code,a.sku_name,a.apply_user_no,a.qtl,a.cytdQtl,a.fytdQtl,(a.xQtl + a.dQtl) stockQtl,(a.cytdXqtl + a.cytdDqtl) cytdStockQtl,(a.fytdXqtl + a.fytdDqtl) fytdStockQtl,
		(case when (a.xQtl + a.dQtl) > 0 then CONCAT(ROUND(COALESCE(CAST(a.qtl AS FLOAT), 0)*100/(a.xQtl + a.dQtl), 2),'%') else '0%' end) rate,
		(case when (a.cytdXqtl + a.cytdDqtl) > 0 then CONCAT(ROUND(COALESCE(CAST(a.cytdQtl AS FLOAT), 0)*100/(a.cytdXqtl + a.cytdDqtl), 2),'%') else '0%'  end) cytdRate,
		(case when (a.fytdXqtl + a.fytdDqtl) > 0 then CONCAT(ROUND(COALESCE(CAST(a.fytdQtl AS FLOAT), 0)*100/(a.fytdXqtl + a.fytdDqtl), 2),'%') else '0%'  end) fytdRate,
		case when CHARINDEX('MR',a.apply_user_no) > 1 then '美容坊' when CHARINDEX('AR',a.apply_user_no) > 1 then 'Aerin' else '正常店铺' end store_attr,
		ms.brand_name,ms.store_name,ms.store_id,ms.region,ms.city,ms.channel,ms.door_type,ms.asm,ms.ac
		from md_store ms,
		(
		select temp.*,cytd.cytdQtl,cytd.cytdXqtl,cytd.cytdDqtl,fytd.fytdQtl,fytd.fytdXqtl,fytd.fytdDqtl from
		-- 当月库存总盗损件数
		(
		select a.*,b.xQtl,b.dQtl from
		(
		select bf.store_no,bfs.sku_code,bfs.sku_name,bf.apply_user_no, sum(bfs.change_total) qtl
		from bd_form bf,bd_form_sku bfs
		where bf.apply_no = bfs.apply_no and bf.form_type = 2 and bf.destroy_type = 4 and bf.dispose_status = 0 and bf.dispose_result = 1
		<if test="queryMap.q_starttime != null and queryMap.q_starttime != ''">
			and bf.update_date >= #{queryMap.q_starttime}
		</if>
		<if test="queryMap.q_endtime != null and queryMap.q_endtime != ''">
			and bf.update_date &lt;= #{queryMap.q_endtime}
		</if>
		group by bf.store_no,bfs.sku_code,bfs.sku_name,bf.apply_user_no
		) a
		left join
		-- 当月库存总消耗件数
		(
		select a.store_no,a.sku_code,a.apply_user_no,a.qtl xQtl,b.qtl dQtl from
		(
		select bf.store_no,bfs.sku_code,bf.apply_user_no, sum(bfs.change_total) qtl
		from bd_form bf,bd_form_sku bfs
		where bf.apply_no = bfs.apply_no and bf.form_type in (2,3) and bf.dispose_status = 0 and bf.dispose_result = 1
		<if test="queryMap.q_starttime != null and queryMap.q_starttime != ''">
			and bf.update_date >= #{queryMap.q_starttime}
		</if>
		<if test="queryMap.q_endtime != null and queryMap.q_endtime != ''">
			and bf.update_date &lt;= #{queryMap.q_endtime}
		</if>
		group by bf.store_no,bfs.sku_code,bf.apply_user_no
		) a
		left join
		-- 当前总库存
		(
		select bsi.store_no,bsi.sku_code,bsi.user_no, sum(bsi.stock_depot + bsi.stock_counter) qtl
		from bd_stock_inv bsi
		group by bsi.store_no,bsi.sku_code,bsi.user_no
		) b
		on a.store_no = b.store_no and a.sku_code = b.sku_code and a.apply_user_no = b.user_no
		) b
		on a.store_no = b.store_no and a.sku_code = b.sku_code and a.apply_user_no = b.apply_user_no
		) temp
		left join
		-- CYTD财年库存总盗损件数
		(
		select a.*,b.cytdXqtl, b.cytdDqtl from
		(
		select bf.store_no,bfs.sku_code,bf.apply_user_no, sum(bfs.change_total) cytdQtl
		from bd_form bf,bd_form_sku bfs
		where bf.apply_no = bfs.apply_no and bf.form_type = 2 and bf.destroy_type = 4 and bf.dispose_status = 0 and bf.dispose_result = 1
		and bf.update_date >= dateadd(yy,datediff(yy,0,getdate()),0)
		and bf.update_date &lt;= getdate()
		group by bf.store_no,bfs.sku_code,bf.apply_user_no
		) a
		left join
		-- CYTD财年库存消耗总件数
		(
		select a.store_no,a.sku_code,a.apply_user_no,a.qtl cytdXqtl,b.qtl cytdDqtl from
		(
		select bf.store_no,bfs.sku_code,bf.apply_user_no, sum(bfs.change_total) qtl
		from bd_form bf,bd_form_sku bfs
		where bf.apply_no = bfs.apply_no and bf.form_type in (2,3) and bf.dispose_status = 0 and bf.dispose_result = 1
		and bf.update_date >= dateadd(yy,datediff(yy,0,getdate()),0)
		and bf.update_date &lt;= getdate()
		group by bf.store_no,bfs.sku_code,bf.apply_user_no
		) a
		left join
		-- 当前库存总数
		(
		select bsi.store_no,bsi.sku_code,bsi.user_no, sum(bsi.stock_depot + bsi.stock_counter) qtl
		from bd_stock_inv bsi
		group by bsi.store_no,bsi.sku_code,bsi.user_no
		) b
		on a.store_no = b.store_no and a.sku_code = b.sku_code and a.apply_user_no = b.user_no
		) b
		on a.store_no = b.store_no and a.sku_code = b.sku_code and a.apply_user_no = b.apply_user_no
		) cytd
		on temp.store_no = cytd.store_no and temp.sku_code = cytd.sku_code and temp.apply_user_no = cytd.apply_user_no
		left join
		-- FYTD财年库存总盗损件数
		(
		select a.*,b.fytdXqtl, b.fytdDqtl from
		(
		select bf.store_no,bfs.sku_code,bf.apply_user_no, sum(bfs.change_total) fytdQtl
		from bd_form bf,bd_form_sku bfs
		where bf.apply_no = bfs.apply_no and bf.form_type = 2 and bf.destroy_type = 4 and bf.dispose_status = 0 and bf.dispose_result = 1
		and bf.update_date >=  (case when datediff(hh, concat(DateName(year,GetDate()),'-07-01 00:00:00'), GetDate()) > 0 then concat(DateName(year,GetDate()),'-07-01 00:00:00') else dateadd(yy, -1, concat(DateName(year,GetDate()),'-07-01 00:00:00')) end)
		and bf.update_date &lt;= GetDate()
		group by bf.store_no,bfs.sku_code,bf.apply_user_no
		) a
		left join
		-- FYTD财年库存消耗总件数
		(
		select a.store_no,a.sku_code,a.apply_user_no,a.qtl fytdXqtl,b.qtl fytdDqtl from
		(
		select bf.store_no,bfs.sku_code,bf.apply_user_no, sum(bfs.change_total) qtl
		from bd_form bf,bd_form_sku bfs
		where bf.apply_no = bfs.apply_no and bf.form_type in (2,3) and bf.dispose_status = 0 and bf.dispose_result = 1
		and bf.update_date >=  (case when datediff(hh, concat(DateName(year,GetDate()),'-07-01 00:00:00'), GetDate()) > 0 then concat(DateName(year,GetDate()),'-07-01 00:00:00') else dateadd(yy, -1, concat(DateName(year,GetDate()),'-07-01 00:00:00')) end)
		and bf.update_date &lt;= GetDate()
		group by bf.store_no,bfs.sku_code,bf.apply_user_no
		) a
		left join
		-- 当前库存总数
		(
		select bsi.store_no,bsi.sku_code,bsi.user_no, sum(bsi.stock_depot + bsi.stock_counter) qtl
		from bd_stock_inv bsi
		group by bsi.store_no,bsi.sku_code,bsi.user_no
		) b
		on a.store_no = b.store_no and a.sku_code = b.sku_code and a.apply_user_no = b.user_no
		) b
		on a.store_no = b.store_no and a.sku_code = b.sku_code and a.apply_user_no = b.apply_user_no
		) fytd
		on temp.store_no = fytd.store_no and temp.sku_code = fytd.sku_code and temp.apply_user_no = fytd.apply_user_no
		) a
        <include refid="getConditionForDestroy"/>
        order by ms.store_no desc
        <if test="size != null and size &gt; 0">offset #{start} row fetch next #{size} row only</if>
    </select>

    <select id="getDestroyTheftFormListCount" parameterType="java.util.Map" resultType="Integer">
        select count(1)
		from md_store ms,
		(
		select temp.*,cytd.cytdQtl,cytd.cytdXqtl,cytd.cytdDqtl,fytd.fytdQtl,fytd.fytdXqtl,fytd.fytdDqtl from
		-- 当月库存总盗损件数
		(
		select a.*,b.xQtl,b.dQtl from
		(
		select bf.store_no,bfs.sku_code,bfs.sku_name,bf.apply_user_no, sum(bfs.change_total) qtl
		from bd_form bf,bd_form_sku bfs
		where bf.apply_no = bfs.apply_no and bf.form_type = 2 and bf.destroy_type = 4 and bf.dispose_status = 0 and bf.dispose_result = 1
		<if test="queryMap.q_starttime != null and queryMap.q_starttime != ''">
			and bf.update_date >= #{queryMap.q_starttime}
		</if>
		<if test="queryMap.q_endtime != null and queryMap.q_endtime != ''">
			and bf.update_date &lt;= #{queryMap.q_endtime}
		</if>
		group by bf.store_no,bfs.sku_code,bfs.sku_name,bf.apply_user_no
		) a
		left join
		-- 当月库存总消耗件数
		(
		select a.store_no,a.sku_code,a.apply_user_no,a.qtl xQtl,b.qtl dQtl from
		(
		select bf.store_no,bfs.sku_code,bf.apply_user_no, sum(bfs.change_total) qtl
		from bd_form bf,bd_form_sku bfs
		where bf.apply_no = bfs.apply_no and bf.form_type in (2,3) and bf.dispose_status = 0 and bf.dispose_result = 1
		<if test="queryMap.q_starttime != null and queryMap.q_starttime != ''">
			and bf.update_date >= #{queryMap.q_starttime}
		</if>
		<if test="queryMap.q_endtime != null and queryMap.q_endtime != ''">
			and bf.update_date &lt;= #{queryMap.q_endtime}
		</if>
		group by bf.store_no,bfs.sku_code,bf.apply_user_no
		) a
		left join
		-- 当前总库存
		(
		select bsi.store_no,bsi.sku_code,bsi.user_no, sum(bsi.stock_depot + bsi.stock_counter) qtl
		from bd_stock_inv bsi
		group by bsi.store_no,bsi.sku_code,bsi.user_no
		) b
		on a.store_no = b.store_no and a.sku_code = b.sku_code and a.apply_user_no = b.user_no
		) b
		on a.store_no = b.store_no and a.sku_code = b.sku_code and a.apply_user_no = b.apply_user_no
		) temp
		left join
		-- CYTD财年库存总盗损件数
		(
		select a.*,b.cytdXqtl, b.cytdDqtl from
		(
		select bf.store_no,bfs.sku_code,bf.apply_user_no, sum(bfs.change_total) cytdQtl
		from bd_form bf,bd_form_sku bfs
		where bf.apply_no = bfs.apply_no and bf.form_type = 2 and bf.destroy_type = 4 and bf.dispose_status = 0 and bf.dispose_result = 1
		and bf.update_date >= dateadd(yy,datediff(yy,0,getdate()),0)
		and bf.update_date &lt;= getdate()
		group by bf.store_no,bfs.sku_code,bf.apply_user_no
		) a
		left join
		-- CYTD财年库存消耗总件数
		(
		select a.store_no,a.sku_code,a.apply_user_no,a.qtl cytdXqtl,b.qtl cytdDqtl from
		(
		select bf.store_no,bfs.sku_code,bf.apply_user_no, sum(bfs.change_total) qtl
		from bd_form bf,bd_form_sku bfs
		where bf.apply_no = bfs.apply_no and bf.form_type in (2,3) and bf.dispose_status = 0 and bf.dispose_result = 1
		and bf.update_date >= dateadd(yy,datediff(yy,0,getdate()),0)
		and bf.update_date &lt;= getdate()
		group by bf.store_no,bfs.sku_code,bf.apply_user_no
		) a
		left join
		-- 当前库存总数
		(
		select bsi.store_no,bsi.sku_code,bsi.user_no, sum(bsi.stock_depot + bsi.stock_counter) qtl
		from bd_stock_inv bsi
		group by bsi.store_no,bsi.sku_code,bsi.user_no
		) b
		on a.store_no = b.store_no and a.sku_code = b.sku_code and a.apply_user_no = b.user_no
		) b
		on a.store_no = b.store_no and a.sku_code = b.sku_code and a.apply_user_no = b.apply_user_no
		) cytd
		on temp.store_no = cytd.store_no and temp.sku_code = cytd.sku_code and temp.apply_user_no = cytd.apply_user_no
		left join
		-- FYTD财年库存总盗损件数
		(
		select a.*,b.fytdXqtl, b.fytdDqtl from
		(
		select bf.store_no,bfs.sku_code,bf.apply_user_no, sum(bfs.change_total) fytdQtl
		from bd_form bf,bd_form_sku bfs
		where bf.apply_no = bfs.apply_no and bf.form_type = 2 and bf.destroy_type = 4 and bf.dispose_status = 0 and bf.dispose_result = 1
		and bf.update_date >=  (case when datediff(hh, concat(DateName(year,GetDate()),'-07-01 00:00:00'), GetDate()) > 0 then concat(DateName(year,GetDate()),'-07-01 00:00:00') else dateadd(yy, -1, concat(DateName(year,GetDate()),'-07-01 00:00:00')) end)
		and bf.update_date &lt;= GetDate()
		group by bf.store_no,bfs.sku_code,bf.apply_user_no
		) a
		left join
		-- FYTD财年库存消耗总件数
		(
		select a.store_no,a.sku_code,a.apply_user_no,a.qtl fytdXqtl,b.qtl fytdDqtl from
		(
		select bf.store_no,bfs.sku_code,bf.apply_user_no, sum(bfs.change_total) qtl
		from bd_form bf,bd_form_sku bfs
		where bf.apply_no = bfs.apply_no and bf.form_type in (2,3) and bf.dispose_status = 0 and bf.dispose_result = 1
		and bf.update_date >=  (case when datediff(hh, concat(DateName(year,GetDate()),'-07-01 00:00:00'), GetDate()) > 0 then concat(DateName(year,GetDate()),'-07-01 00:00:00') else dateadd(yy, -1, concat(DateName(year,GetDate()),'-07-01 00:00:00')) end)
		and bf.update_date &lt;= GetDate()
		group by bf.store_no,bfs.sku_code,bf.apply_user_no
		) a
		left join
		-- 当前库存总数
		(
		select bsi.store_no,bsi.sku_code,bsi.user_no, sum(bsi.stock_depot + bsi.stock_counter) qtl
		from bd_stock_inv bsi
		group by bsi.store_no,bsi.sku_code,bsi.user_no
		) b
		on a.store_no = b.store_no and a.sku_code = b.sku_code and a.apply_user_no = b.user_no
		) b
		on a.store_no = b.store_no and a.sku_code = b.sku_code and a.apply_user_no = b.apply_user_no
		) fytd
		on temp.store_no = fytd.store_no and temp.sku_code = fytd.sku_code and temp.apply_user_no = fytd.apply_user_no
		) a
        <include refid="getConditionForDestroy"/>
    </select>

	<select id="getDSIFormList" parameterType="java.util.Map" resultMap="GetDSIFormListBeanResult">
		select a.*,case when CHARINDEX('MR',a.apply_user_no) > 1 then '美容坊' when CHARINDEX('AR',a.apply_user_no) > 1 then 'Aerin' else '正常店铺' end store_attr,
		ms.brand_name,ms.store_name,ms.store_id,ms.region,ms.city,ms.channel,ms.door_type,ms.asm,ms.ac
		from md_store ms,
		(
		select a.*,b.move_number,b.input_date b_input_date,c.stock_counter,c.update_date c_update_date,
		(abs(datediff(day,case when b.input_date is null then c.update_date else b.input_date end,a.input_date)) + 1) dsi
		from
		(
		select bf.store_no,bf.apply_no,bf.input_date,bf.apply_user_no,bfs.sku_code,bfs.sku_name,bfs.change_total qtl
		from bd_form bf, bd_form_sku bfs
		where bf.apply_no = bfs.apply_no and bf.form_type = 2 and bf.dispose_result = 1
		<if test="queryMap.q_starttime != null and queryMap.q_starttime != ''">
			and bf.update_date >= #{queryMap.q_starttime}
		</if>
		<if test="queryMap.q_endtime != null and queryMap.q_endtime != ''">
			and bf.update_date &lt;= #{queryMap.q_endtime}
		</if>
		) a
		left join
		(
		select bsil.store_no,bsil.sku_code,bsil.move_number,bsil.user_no,bsil.input_date
		from bd_stock_inv_log bsil
		where bsil.type = 1
		) b
		on a.store_no = b.store_no and a.sku_code = b.sku_code and a.apply_user_no = b.user_no
		left join
		(
		select bsi.store_no,bsi.sku_code,bsi.user_no,bsi.stock_counter,bsi.update_date
		from bd_stock_inv bsi
		) c
		on a.store_no = c.store_no and a.sku_code = c.sku_code and a.apply_user_no = c.user_no
		) a
		<include refid="getConditionForDestroy"/>
		order by a.apply_no desc
		<if test="size != null and size &gt; 0">offset #{start} row fetch next #{size} row only</if>
	</select>

	<select id="getDSIFormListCount" parameterType="java.util.Map" resultType="Integer">
		select count(1)
		from md_store ms,
		(
		select a.*,b.move_number,b.input_date b_input_date,c.stock_counter,c.update_date c_update_date,
		(abs(datediff(day,case when b.input_date is null then c.update_date else b.input_date end,a.input_date)) + 1) dsi
		from
		(
		select bf.store_no,bf.apply_no,bf.input_date,bf.apply_user_no,bfs.sku_code,bfs.sku_name,bfs.change_total qtl
		from bd_form bf, bd_form_sku bfs
		where bf.apply_no = bfs.apply_no and bf.form_type = 2 and bf.dispose_result = 1
		<if test="queryMap.q_starttime != null and queryMap.q_starttime != ''">
			and bf.update_date >= #{queryMap.q_starttime}
		</if>
		<if test="queryMap.q_endtime != null and queryMap.q_endtime != ''">
			and bf.update_date &lt;= #{queryMap.q_endtime}
		</if>
		) a
		left join
		(
		select bsil.store_no,bsil.sku_code,bsil.move_number,bsil.user_no,bsil.input_date
		from bd_stock_inv_log bsil
		where bsil.type = 1
		) b
		on a.store_no = b.store_no and a.sku_code = b.sku_code and a.apply_user_no = b.user_no
		left join
		(
		select bsi.store_no,bsi.sku_code,bsi.user_no,bsi.stock_counter,bsi.update_date
		from bd_stock_inv bsi
		) c
		on a.store_no = c.store_no and a.sku_code = c.sku_code and a.apply_user_no = c.user_no
		) a
		<include refid="getConditionForDestroy"/>
	</select>
	
	<update id="update" parameterType="com.iyeed.core.entity.form.BdForm">
        update bd_form
    	<set>
			<if test="storeNo != null">store_no= #{storeNo},</if>
			<if test="storeName != null">store_name= #{storeName},</if>
			<if test="applyNo != null">apply_no= #{applyNo},</if>
			<if test="applicant != null">applicant= #{applicant},</if>
			<if test="applicantTel != null">applicant_tel= #{applicantTel},</if>
			<if test="remark != null">remark= #{remark},</if>
			<if test="applyDate != null">apply_date= #{applyDate},</if>
			<if test="destroyType != null">destroy_type= #{destroyType},</if>
			<if test="receiveStoreNo != null">receive_store_no= #{receiveStoreNo},</if>
			<if test="receiveStoreName != null">receive_store_name= #{receiveStoreName},</if>
			<if test="expressCode != null">express_code= #{expressCode},</if>
			<if test="expressName != null">express_name= #{expressName},</if>
			<if test="orderNo != null">order_no= #{orderNo},</if>
			<if test="expressDate != null">express_date= #{expressDate},</if>
			<if test="allotType != null">allot_type= #{allotType},</if>
			<if test="exceptionType != null">exception_type= #{exceptionType},</if>
			<if test="formType != null">form_type= #{formType},</if>
			<if test="disposeUserNo != null">dispose_user_no= #{disposeUserNo},</if>
			<if test="disposeStatus != null">dispose_status= #{disposeStatus},</if>
			<if test="disposeStatusDesc != null">dispose_status_desc= #{disposeStatusDesc},</if>
			<if test="disposeGrade != null">dispose_grade= #{disposeGrade},</if>
			<if test="inputDate != null">input_date= #{inputDate},</if>
			<if test="applyUserNo != null">apply_user_no= #{applyUserNo},</if>
			<if test="updateDate != null">update_date= #{updateDate},</if>
			<if test="sendMailDate != null">send_mail_date= #{sendMailDate},</if>
			<if test="isBack != null">is_back= #{isBack},</if>
			<if test="disposeResult != null">dispose_result= #{disposeResult}</if>
	    </set>
        where id = #{id}
	</update>

	<update id="updateForSendFormMail" parameterType="com.iyeed.core.entity.form.vo.FormJobForm">
		update bd_form
		set send_mail_date= getdate()
		where id in
		<foreach item="id" index="index" collection="idArr" open="(" separator="," close=")">
			#{id}
		</foreach>
	</update>

	<update id="updateForChangeAudit" parameterType="com.iyeed.core.entity.form.vo.FormJobForm">
		update bd_form
		<set>
			<if test="disposeUserNo != null">dispose_user_no= #{disposeUserNo},</if>
			<if test="disposeStatus != null">dispose_status= #{disposeStatus},</if>
			<if test="disposeStatusDesc != null">dispose_status_desc= #{disposeStatusDesc},</if>
			<if test="disposeGrade != null">dispose_grade= #{disposeGrade},</if>
			<if test="updateDate != null">update_date= #{updateDate},</if>
			<if test="sendMailDate != null">send_mail_date= #{sendMailDate}</if>
		</set>
		where id = #{id}
	</update>

	<delete id="delBdForm" parameterType="Integer">
		delete from bd_form where id = #{id}
	</delete>

	<delete id="delBdFormByApplyNo" parameterType="String">
		delete from bd_form where apply_no = #{applyNo}
	</delete>
	
	<insert id="insert" parameterType="com.iyeed.core.entity.form.BdForm" useGeneratedKeys="true" keyProperty="id" keyColumn="id">
		insert into 
		bd_form
		(
			
			store_no,
			store_name,
			apply_no,
			applicant,
			applicant_tel,
			remark,
			apply_date,
			destroy_type,
			receive_store_no,
			receive_store_name,
			express_code,
			express_name,
			order_no,
			express_date,
			allot_type,
			exception_type,
			form_type,
			dispose_user_no,
			dispose_status,
			dispose_status_desc,
			dispose_grade,
			apply_user_no,
			is_back,
			brand_no
		)
		values
		(
			
			#{storeNo},
			#{storeName},
			#{applyNo},
			#{applicant},
			#{applicantTel},
			#{remark},
			#{applyDate},
			#{destroyType},
			#{receiveStoreNo},
			#{receiveStoreName},
			#{expressCode},
			#{expressName},
			#{orderNo},
			#{expressDate},
			#{allotType},
			#{exceptionType},
			#{formType},
			#{disposeUserNo},
			#{disposeStatus},
			#{disposeStatusDesc},
			#{disposeGrade},
			#{applyUserNo},
			#{isBack},
			#{brandNo}
		)
	</insert>

	<sql id="getConditionForDestroy">
		<where>
			ms.store_no = a.store_no
			<if test="queryMap.q_storeNo != null and queryMap.q_storeNo !=''">
				and ms.store_no = #{queryMap.q_storeNo}
			</if>
			<if test="queryMap.q_brandNo != null and queryMap.q_brandNo !=''">
				and ms.brand_code = (select brand_code from md_brand where brand_no = #{queryMap.q_brandNo})
			</if>
			<if test="queryMap.q_storeNoArr != null and queryMap.q_storeNoArr !=''">
				and ms.store_no in
				<foreach item="storeNo" index="index" collection="queryMap.q_storeNoArr" open="(" separator="," close=")">
					#{storeNo}
				</foreach>
			</if>
		</where>
	</sql>

	<sql id="getCondition">
		<where>
			bf.store_no = ms.store_no
			<if test="queryMap.q_disposeUserNo != null and queryMap.q_disposeUserNo !=''">
				and bf.dispose_user_no = #{queryMap.q_disposeUserNo}
			</if>
			<if test="queryMap.q_storeNo != null and queryMap.q_storeNo !=''">
				and bf.store_no = #{queryMap.q_storeNo}
			</if>
			<if test="queryMap.q_brandNo != null and queryMap.q_brandNo !=''">
				and ms.brand_code = (select brand_code from md_brand where brand_no = #{queryMap.q_brandNo})
			</if>
			<if test="queryMap.q_applyNo != null and queryMap.q_applyNo !=''">
				and bf.apply_no = #{queryMap.q_applyNo}
			</if>
			<if test="queryMap.q_userNo != null and queryMap.q_userNo !=''">
				and bf.apply_user_no = #{queryMap.q_userNo}
			</if>
			<if test="queryMap.q_disposeStatus != null and queryMap.q_disposeStatus !=''">
				<if test="queryMap.q_disposeStatus == 1">
					and bf.dispose_status IN (1,2,3)
				</if>
				<if test="queryMap.q_disposeStatus == 2">
					and bf.dispose_status IN (1,2)
				</if>
				<if test="queryMap.q_disposeStatus == 0">
					and bf.dispose_status = #{queryMap.q_disposeStatus}
				</if>
			</if>
			<if test="queryMap.q_storeNoArr != null and queryMap.q_storeNoArr !=''">
				and bf.store_no in
				<foreach item="storeNo" index="index" collection="queryMap.q_storeNoArr" open="(" separator="," close=")">
					#{storeNo}
				</foreach>
			</if>
			<if test="queryMap.q_formType != null and queryMap.q_formType !=''">
				and bf.form_type = #{queryMap.q_formType}
			</if>
			<if test="queryMap.q_starttime != null and queryMap.q_starttime != ''">
				and bf.apply_date &gt;= #{queryMap.q_starttime}
			</if>
			<if test="queryMap.q_endtime != null and queryMap.q_endtime != ''">
				and bf.apply_date &lt;= #{queryMap.q_endtime}
			</if>
		</where>
	</sql>

	<select id="getExceptionReportList" parameterType="java.util.Map" resultMap="ExceptionReportBeanResult">
		select bfs.id,bf.store_no,bf.store_name,bf.apply_no,bf.apply_date,bf.exception_type,
		bf.dispose_status,ms.brand_name,bfs.sku_code,bfs.sku_name,bfs.change_type,bfs.change_total
		from bd_form bf,bd_form_sku bfs, md_sku ms
		<include refid="getExceptionReportCondition"/>
		order by bf.apply_date desc
		<if test="size != null and size &gt; 0">offset #{start} row fetch next #{size} row only</if>
	</select>

	<select id="getExceptionReportListCount" parameterType="java.util.Map" resultType="Integer">
		SELECT count(*)
		from bd_form bf,bd_form_sku bfs, md_sku ms
		<include refid="getExceptionReportCondition"/>
	</select>

	<sql id="getExceptionReportCondition">
		<where>
			bf.apply_no = bfs.apply_no and bfs.sku_code = ms.sku_code and bf.form_type = 4
			<if test="queryMap.q_storeNo != null and queryMap.q_storeNo !=''">
				and bf.store_no = #{queryMap.q_storeNo}
			</if>
			<if test="queryMap.q_applyNo != null and queryMap.q_applyNo !=''">
				and bf.apply_no = #{queryMap.q_applyNo}
			</if>
			<if test="queryMap.q_disposeStatus != null and queryMap.q_disposeStatus !=''">
				<if test="queryMap.q_disposeStatus == 1">
					and bf.dispose_status IN (1,2,3)
				</if>
				<if test="queryMap.q_disposeStatus == 2">
					and bf.dispose_status IN (1,2)
				</if>
				<if test="queryMap.q_disposeStatus == 0">
					and bf.dispose_status = #{queryMap.q_disposeStatus}
				</if>
			</if>
			<if test="queryMap.q_storeNoArr != null and queryMap.q_storeNoArr !=''">
				and bf.store_no in
				<foreach item="storeNo" index="index" collection="queryMap.q_storeNoArr" open="(" separator="," close=")">
					#{storeNo}
				</foreach>
			</if>
			<if test="queryMap.q_starttime != null and queryMap.q_starttime != ''">
				and bf.apply_date &gt;= #{queryMap.q_starttime}
			</if>
			<if test="queryMap.q_endtime != null and queryMap.q_endtime != ''">
				and bf.apply_date &lt;= #{queryMap.q_endtime}
			</if>
		</where>
	</sql>

	<select id="getStockReportList" parameterType="java.util.Map" resultMap="StockReportBeanResult">
		select temp.*, ms.brand_no,ms.region,ms.city,ms.channel,ms.door_type,ms.asm,ms.ac
		from
		(
			select a.store_no, a.store_name, a.user_no, isnull(a.stock_total,0) stock_total, isnull(b.send_total,0) b_send_total,
			isnull(c.send_total,0) c_send_total, isnull(d.act_send_total,0) d_act_send_total, isnull(e.act_send_total,0) e_act_send_total,
			isnull(f.change_total,0) f_change_total, isnull(g.change_total,0) g_change_total, isnull(h.change_total,0) h_change_total,
			isnull(i.change_total,0) i_change_total, isnull(j.change_total,0) j_change_total, isnull(k.change_total,0) k_change_total,
			isnull(l.change_total,0) l_change_total,
			-- 期初库存
			(
			isnull(a.stock_total,0) - isnull(d.act_send_total,0) - isnull(e.act_send_total,0) + isnull(f.change_total,0) + isnull(g.change_total,0)
			+ isnull(h.change_total,0) + isnull(i.change_total,0) + isnull(j.change_total,0) - isnull(k.change_total,0) + isnull(l.change_total,0)
			) stock_total_a
			from
			(
				-- 期末库存
				select store_no, store_name, user_no, sum(stock_depot) stock_depot, sum(stock_depot_enabled) stock_depot_enabled,
				sum(stock_depot_freeze)  stock_depot_freeze, sum(stock_counter) stock_counter,
				sum(stock_counter_enabled) stock_counter_enabled, sum(stock_counter_freeze) stock_counter_freeze,
				(sum(stock_depot_enabled) + sum(stock_counter_enabled)) stock_total
				from bd_stock_inv
				group by store_no, store_name, user_no
			) a
			left join
			(
				-- 未收货，调拨
				select br.send_type, br.send_store_no, br.receive_store_no, br.receive_user_no, br.status,
				sum(brs.send_total) send_total, sum(brs.act_send_total) act_send_total
				from bd_receiving br, bd_receiving_sku brs
				where br.erp_no = brs.erp_no and br.status = 1 and br.send_type = 1
				<if test="queryMap.q_starttime != null and queryMap.q_starttime != ''">
					and br.send_date &gt;= #{queryMap.q_starttime}
				</if>
				<if test="queryMap.q_endtime != null and queryMap.q_endtime != ''">
					and br.send_date &lt;= #{queryMap.q_endtime}
				</if>
				group by br.send_type, br.send_store_no, br.receive_store_no, br.receive_user_no, br.status
			) b
			on a.user_no = b.receive_store_no
			left join
			(
				-- 未收货，大仓
				select br.send_type, br.send_store_no, br.receive_store_no, br.receive_user_no, br.status,
				sum(brs.send_total) send_total, sum(brs.act_send_total) act_send_total
				from bd_receiving br, bd_receiving_sku brs
				where br.erp_no = brs.erp_no and br.status = 1 and br.send_type = 2
				<if test="queryMap.q_starttime != null and queryMap.q_starttime != ''">
					and br.send_date &gt;= #{queryMap.q_starttime}
				</if>
				<if test="queryMap.q_endtime != null and queryMap.q_endtime != ''">
					and br.send_date &lt;= #{queryMap.q_endtime}
				</if>
				group by br.send_type, br.send_store_no, br.receive_store_no, br.receive_user_no, br.status
			) c
			on a.user_no = c.receive_store_no
			left join
			(
				-- 已收货，调拨
				select br.send_type, br.send_store_no, br.receive_user_no, br.status,
				sum(brs.send_total) send_total, sum(brs.act_send_total) act_send_total
				from bd_receiving br, bd_receiving_sku brs
				where br.erp_no = brs.erp_no and br.status = 2 and br.send_type = 1
				<if test="queryMap.q_starttime != null and queryMap.q_starttime != ''">
					and br.receive_date &gt;= #{queryMap.q_starttime}
				</if>
				<if test="queryMap.q_endtime != null and queryMap.q_endtime != ''">
					and br.receive_date &lt;= #{queryMap.q_endtime}
				</if>
				group by br.send_type, br.send_store_no, br.receive_user_no, br.status
			) d
			on a.user_no = d.receive_user_no
			left join
			(
				-- 已收货，大仓
				select br.send_type, br.send_store_no, br.receive_user_no, br.status,
				sum(brs.send_total) send_total, sum(brs.act_send_total) act_send_total
				from bd_receiving br, bd_receiving_sku brs
				where br.erp_no = brs.erp_no and br.status = 2 and br.send_type = 2
				<if test="queryMap.q_starttime != null and queryMap.q_starttime != ''">
					and br.receive_date &gt;= #{queryMap.q_starttime}
				</if>
				<if test="queryMap.q_endtime != null and queryMap.q_endtime != ''">
					and br.receive_date &lt;= #{queryMap.q_endtime}
				</if>
				group by br.send_type, br.send_store_no, br.receive_user_no, br.status
			) e
			on a.user_no = e.receive_user_no
			left join
			(
				-- 销毁，正常使用完毕
				select bf.store_no, bf.store_name, bf.apply_user_no, bf.form_type, bf.destroy_type,
				sum(stock_depot_total) stock_depot_total, sum(stock_counter_total) stock_counter_total,
				sum(change_total) change_total, change_type
				from bd_form bf, bd_form_sku bfs
				where bf.apply_no = bfs.apply_no and bf.form_type = 2 and bf.destroy_type = 1
                and bf.dispose_result = 1
				<if test="queryMap.q_starttime != null and queryMap.q_starttime != ''">
					and bf.apply_date &gt;= #{queryMap.q_starttime}
				</if>
				<if test="queryMap.q_endtime != null and queryMap.q_endtime != ''">
					and bf.apply_date &lt;= #{queryMap.q_endtime}
				</if>
				group by bf.store_no, bf.store_name, bf.apply_user_no, bf.form_type, bf.destroy_type, bfs.change_type
			) f
			on a.user_no = f.apply_user_no
			left join
			(
				-- 销毁，破损
				select bf.store_no, bf.store_name, bf.apply_user_no, bf.form_type, bf.destroy_type,
				sum(stock_depot_total) stock_depot_total, sum(stock_counter_total) stock_counter_total,
				sum(change_total) change_total, change_type
				from bd_form bf, bd_form_sku bfs
				where bf.apply_no = bfs.apply_no and bf.form_type = 2 and bf.destroy_type = 2
                and bf.dispose_result = 1
				<if test="queryMap.q_starttime != null and queryMap.q_starttime != ''">
					and bf.apply_date &gt;= #{queryMap.q_starttime}
				</if>
				<if test="queryMap.q_endtime != null and queryMap.q_endtime != ''">
					and bf.apply_date &lt;= #{queryMap.q_endtime}
				</if>
				group by bf.store_no, bf.store_name, bf.apply_user_no, bf.form_type, bf.destroy_type, bfs.change_type
			) g
			on a.user_no = g.apply_user_no
			left join
			(
				-- 销毁，过期
				select bf.store_no, bf.store_name, bf.apply_user_no, bf.form_type, bf.destroy_type,
				sum(stock_depot_total) stock_depot_total, sum(stock_counter_total) stock_counter_total,
				sum(change_total) change_total, change_type
				from bd_form bf, bd_form_sku bfs
				where bf.apply_no = bfs.apply_no and bf.form_type = 2 and bf.destroy_type = 3
                and bf.dispose_result = 1
				<if test="queryMap.q_starttime != null and queryMap.q_starttime != ''">
					and bf.apply_date &gt;= #{queryMap.q_starttime}
				</if>
				<if test="queryMap.q_endtime != null and queryMap.q_endtime != ''">
					and bf.apply_date &lt;= #{queryMap.q_endtime}
				</if>
				group by bf.store_no, bf.store_name, bf.apply_user_no, bf.form_type, bf.destroy_type, bfs.change_type
			) h
			on a.user_no = h.apply_user_no
			left join
			(
				-- 销毁，失窃
				select bf.store_no, bf.store_name, bf.apply_user_no, bf.form_type, bf.destroy_type,
				sum(stock_depot_total) stock_depot_total, sum(stock_counter_total) stock_counter_total,
				sum(change_total) change_total, change_type
				from bd_form bf, bd_form_sku bfs
				where bf.apply_no = bfs.apply_no and bf.form_type = 2 and bf.destroy_type = 4
                and bf.dispose_result = 1
				<if test="queryMap.q_starttime != null and queryMap.q_starttime != ''">
					and bf.apply_date &gt;= #{queryMap.q_starttime}
				</if>
				<if test="queryMap.q_endtime != null and queryMap.q_endtime != ''">
					and bf.apply_date &lt;= #{queryMap.q_endtime}
				</if>
				group by bf.store_no, bf.store_name, bf.apply_user_no, bf.form_type, bf.destroy_type, bfs.change_type
			) i
			on a.user_no = i.apply_user_no
			left join
			(
				-- 调出
				select bf.store_no, bf.store_name, bf.apply_user_no, bf.form_type, bf.destroy_type,
				sum(stock_depot_total) stock_depot_total, sum(stock_counter_total) stock_counter_total,
				sum(change_total) change_total, change_type
				from bd_form bf, bd_form_sku bfs
				where bf.apply_no = bfs.apply_no and bf.form_type = 3
                and bf.dispose_result = 1
				<if test="queryMap.q_starttime != null and queryMap.q_starttime != ''">
					and bf.apply_date &gt;= #{queryMap.q_starttime}
				</if>
				<if test="queryMap.q_endtime != null and queryMap.q_endtime != ''">
					and bf.apply_date &lt;= #{queryMap.q_endtime}
				</if>
				group by bf.store_no, bf.store_name, bf.apply_user_no, bf.form_type, bf.destroy_type, bfs.change_type
			) j
			on a.user_no = j.apply_user_no
			left join
			(
				-- 异常调整-增加
				select bf.store_no, bf.store_name, bf.apply_user_no, bf.form_type, bf.destroy_type,
				sum(stock_depot_total) stock_depot_total, sum(stock_counter_total) stock_counter_total,
				sum(change_total) change_total, change_type
				from bd_form bf, bd_form_sku bfs
				where bf.apply_no = bfs.apply_no and bf.form_type = 4 and bfs.change_type = 1
                and bf.dispose_result = 1
				<if test="queryMap.q_starttime != null and queryMap.q_starttime != ''">
					and bf.apply_date &gt;= #{queryMap.q_starttime}
				</if>
				<if test="queryMap.q_endtime != null and queryMap.q_endtime != ''">
					and bf.apply_date &lt;= #{queryMap.q_endtime}
				</if>
				group by bf.store_no, bf.store_name, bf.apply_user_no, bf.form_type, bf.destroy_type, bfs.change_type
			) k
			on a.user_no = k.apply_user_no
			left join
			(
				-- 异常调整-减少
				select bf.store_no, bf.store_name, bf.apply_user_no, bf.form_type, bf.destroy_type,
				sum(stock_depot_total) stock_depot_total, sum(stock_counter_total) stock_counter_total,
				sum(change_total) change_total, change_type
				from bd_form bf, bd_form_sku bfs
				where bf.apply_no = bfs.apply_no and bf.form_type = 4 and bfs.change_type = 2
                and bf.dispose_result = 1
				<if test="queryMap.q_starttime != null and queryMap.q_starttime != ''">
					and bf.apply_date &gt;= #{queryMap.q_starttime}
				</if>
				<if test="queryMap.q_endtime != null and queryMap.q_endtime != ''">
					and bf.apply_date &lt;= #{queryMap.q_endtime}
				</if>
				group by bf.store_no, bf.store_name, bf.apply_user_no, bf.form_type, bf.destroy_type, bfs.change_type
			) l
			on a.user_no = l.apply_user_no
		) temp, md_store ms
		<include refid="getStockReportCondition"/>
		order by temp.user_no desc
		<if test="size != null and size &gt; 0">offset #{start} row fetch next #{size} row only</if>
	</select>

	<select id="getStockReportListCount" parameterType="java.util.Map" resultType="Integer">
		select count(1)
		from
		(
			select a.store_no, a.store_name, a.user_no, isnull(a.stock_total,0) stock_total, isnull(b.send_total,0) b_send_total,
			isnull(c.send_total,0) c_send_total, isnull(d.act_send_total,0) d_act_send_total, isnull(e.act_send_total,0) e_act_send_total,
			isnull(f.change_total,0) f_change_total, isnull(g.change_total,0) g_change_total, isnull(h.change_total,0) h_change_total,
			isnull(i.change_total,0) i_change_total, isnull(j.change_total,0) j_change_total, isnull(k.change_total,0) k_change_total,
			isnull(l.change_total,0) l_change_total,
			-- 期初库存
			(
			isnull(a.stock_total,0) - isnull(d.act_send_total,0) - isnull(e.act_send_total,0) + isnull(f.change_total,0) + isnull(g.change_total,0)
			+ isnull(h.change_total,0) + isnull(i.change_total,0) + isnull(j.change_total,0) - isnull(k.change_total,0) + isnull(l.change_total,0)
			) stock_total_a
			from
			(
				-- 期末库存
				select store_no, store_name, user_no, sum(stock_depot) stock_depot, sum(stock_depot_enabled) stock_depot_enabled,
				sum(stock_depot_freeze)  stock_depot_freeze, sum(stock_counter) stock_counter,
				sum(stock_counter_enabled) stock_counter_enabled, sum(stock_counter_freeze) stock_counter_freeze,
				(sum(stock_depot) + sum(stock_counter)) stock_total
				from bd_stock_inv
				group by store_no, store_name, user_no
			) a
			left join
			(
				-- 未收货，调拨
				select br.send_type, br.send_store_no, br.receive_store_no, br.receive_user_no, br.status,
				sum(brs.send_total) send_total, sum(brs.act_send_total) act_send_total
				from bd_receiving br, bd_receiving_sku brs
				where br.erp_no = brs.erp_no and br.status = 1 and br.send_type = 1
				<if test="queryMap.q_starttime != null and queryMap.q_starttime != ''">
					and br.send_date &gt;= #{queryMap.q_starttime}
				</if>
				<if test="queryMap.q_endtime != null and queryMap.q_endtime != ''">
					and br.send_date &lt;= #{queryMap.q_endtime}
				</if>
				group by br.send_type, br.send_store_no, br.receive_store_no, br.receive_user_no, br.status
			) b
			on a.user_no = b.receive_store_no
			left join
			(
				-- 未收货，大仓
				select br.send_type, br.send_store_no, br.receive_store_no, br.receive_user_no, br.status,
				sum(brs.send_total) send_total, sum(brs.act_send_total) act_send_total
				from bd_receiving br, bd_receiving_sku brs
				where br.erp_no = brs.erp_no and br.status = 1 and br.send_type = 2
				<if test="queryMap.q_starttime != null and queryMap.q_starttime != ''">
					and br.send_date &gt;= #{queryMap.q_starttime}
				</if>
				<if test="queryMap.q_endtime != null and queryMap.q_endtime != ''">
					and br.send_date &lt;= #{queryMap.q_endtime}
				</if>
				group by br.send_type, br.send_store_no, br.receive_store_no, br.receive_user_no, br.status
			) c
			on a.user_no = c.receive_store_no
			left join
			(
				-- 已收货，调拨
				select br.send_type, br.send_store_no, br.receive_user_no, br.status,
				sum(brs.send_total) send_total, sum(brs.act_send_total) act_send_total
				from bd_receiving br, bd_receiving_sku brs
				where br.erp_no = brs.erp_no and br.status = 2 and br.send_type = 1
				<if test="queryMap.q_starttime != null and queryMap.q_starttime != ''">
					and br.receive_date &gt;= #{queryMap.q_starttime}
				</if>
				<if test="queryMap.q_endtime != null and queryMap.q_endtime != ''">
					and br.receive_date &lt;= #{queryMap.q_endtime}
				</if>
				group by br.send_type, br.send_store_no, br.receive_user_no, br.status
			) d
			on a.user_no = d.receive_user_no
			left join
			(
				-- 已收货，大仓
				select br.send_type, br.send_store_no, br.receive_user_no, br.status,
				sum(brs.send_total) send_total, sum(brs.act_send_total) act_send_total
				from bd_receiving br, bd_receiving_sku brs
				where br.erp_no = brs.erp_no and br.status = 2 and br.send_type = 2
				<if test="queryMap.q_starttime != null and queryMap.q_starttime != ''">
					and br.receive_date &gt;= #{queryMap.q_starttime}
				</if>
				<if test="queryMap.q_endtime != null and queryMap.q_endtime != ''">
					and br.receive_date &lt;= #{queryMap.q_endtime}
				</if>
				group by br.send_type, br.send_store_no, br.receive_user_no, br.status
			) e
			on a.user_no = e.receive_user_no
			left join
			(
				-- 销毁，正常使用完毕
				select bf.store_no, bf.store_name, bf.apply_user_no, bf.form_type, bf.destroy_type,
				sum(stock_depot_total) stock_depot_total, sum(stock_counter_total) stock_counter_total,
				sum(change_total) change_total, change_type
				from bd_form bf, bd_form_sku bfs
				where bf.apply_no = bfs.apply_no and bf.form_type = 2 and bf.destroy_type = 1
                and bf.dispose_result = 1
				<if test="queryMap.q_starttime != null and queryMap.q_starttime != ''">
					and bf.apply_date &gt;= #{queryMap.q_starttime}
				</if>
				<if test="queryMap.q_endtime != null and queryMap.q_endtime != ''">
					and bf.apply_date &lt;= #{queryMap.q_endtime}
				</if>
				group by bf.store_no, bf.store_name, bf.apply_user_no, bf.form_type, bf.destroy_type, bfs.change_type
			) f
			on a.user_no = f.apply_user_no
			left join
			(
				-- 销毁，破损
				select bf.store_no, bf.store_name, bf.apply_user_no, bf.form_type, bf.destroy_type,
				sum(stock_depot_total) stock_depot_total, sum(stock_counter_total) stock_counter_total,
				sum(change_total) change_total, change_type
				from bd_form bf, bd_form_sku bfs
				where bf.apply_no = bfs.apply_no and bf.form_type = 2 and bf.destroy_type = 2
                and bf.dispose_result = 1
				<if test="queryMap.q_starttime != null and queryMap.q_starttime != ''">
					and bf.apply_date &gt;= #{queryMap.q_starttime}
				</if>
				<if test="queryMap.q_endtime != null and queryMap.q_endtime != ''">
					and bf.apply_date &lt;= #{queryMap.q_endtime}
				</if>
				group by bf.store_no, bf.store_name, bf.apply_user_no, bf.form_type, bf.destroy_type, bfs.change_type
			) g
			on a.user_no = g.apply_user_no
			left join
			(
				-- 销毁，过期
				select bf.store_no, bf.store_name, bf.apply_user_no, bf.form_type, bf.destroy_type,
				sum(stock_depot_total) stock_depot_total, sum(stock_counter_total) stock_counter_total,
				sum(change_total) change_total, change_type
				from bd_form bf, bd_form_sku bfs
				where bf.apply_no = bfs.apply_no and bf.form_type = 2 and bf.destroy_type = 3
                and bf.dispose_result = 1
				<if test="queryMap.q_starttime != null and queryMap.q_starttime != ''">
					and bf.apply_date &gt;= #{queryMap.q_starttime}
				</if>
				<if test="queryMap.q_endtime != null and queryMap.q_endtime != ''">
					and bf.apply_date &lt;= #{queryMap.q_endtime}
				</if>
				group by bf.store_no, bf.store_name, bf.apply_user_no, bf.form_type, bf.destroy_type, bfs.change_type
			) h
			on a.user_no = h.apply_user_no
			left join
			(
				-- 销毁，失窃
				select bf.store_no, bf.store_name, bf.apply_user_no, bf.form_type, bf.destroy_type,
				sum(stock_depot_total) stock_depot_total, sum(stock_counter_total) stock_counter_total,
				sum(change_total) change_total, change_type
				from bd_form bf, bd_form_sku bfs
				where bf.apply_no = bfs.apply_no and bf.form_type = 2 and bf.destroy_type = 4
                and bf.dispose_result = 1
				<if test="queryMap.q_starttime != null and queryMap.q_starttime != ''">
					and bf.apply_date &gt;= #{queryMap.q_starttime}
				</if>
				<if test="queryMap.q_endtime != null and queryMap.q_endtime != ''">
					and bf.apply_date &lt;= #{queryMap.q_endtime}
				</if>
				group by bf.store_no, bf.store_name, bf.apply_user_no, bf.form_type, bf.destroy_type, bfs.change_type
			) i
			on a.user_no = i.apply_user_no
			left join
			(
				-- 调出
				select bf.store_no, bf.store_name, bf.apply_user_no, bf.form_type, bf.destroy_type,
				sum(stock_depot_total) stock_depot_total, sum(stock_counter_total) stock_counter_total,
				sum(change_total) change_total, change_type
				from bd_form bf, bd_form_sku bfs
				where bf.apply_no = bfs.apply_no and bf.form_type = 3
                and bf.dispose_result = 1
				<if test="queryMap.q_starttime != null and queryMap.q_starttime != ''">
					and bf.apply_date &gt;= #{queryMap.q_starttime}
				</if>
				<if test="queryMap.q_endtime != null and queryMap.q_endtime != ''">
					and bf.apply_date &lt;= #{queryMap.q_endtime}
				</if>
				group by bf.store_no, bf.store_name, bf.apply_user_no, bf.form_type, bf.destroy_type, bfs.change_type
			) j
			on a.user_no = j.apply_user_no
			left join
			(
				-- 异常调整-增加
				select bf.store_no, bf.store_name, bf.apply_user_no, bf.form_type, bf.destroy_type,
				sum(stock_depot_total) stock_depot_total, sum(stock_counter_total) stock_counter_total,
				sum(change_total) change_total, change_type
				from bd_form bf, bd_form_sku bfs
				where bf.apply_no = bfs.apply_no and bf.form_type = 4 and bfs.change_type = 1
                and bf.dispose_result = 1
				<if test="queryMap.q_starttime != null and queryMap.q_starttime != ''">
					and bf.apply_date &gt;= #{queryMap.q_starttime}
				</if>
				<if test="queryMap.q_endtime != null and queryMap.q_endtime != ''">
					and bf.apply_date &lt;= #{queryMap.q_endtime}
				</if>
				group by bf.store_no, bf.store_name, bf.apply_user_no, bf.form_type, bf.destroy_type, bfs.change_type
			) k
			on a.user_no = k.apply_user_no
			left join
			(
				-- 异常调整-减少
				select bf.store_no, bf.store_name, bf.apply_user_no, bf.form_type, bf.destroy_type,
				sum(stock_depot_total) stock_depot_total, sum(stock_counter_total) stock_counter_total,
				sum(change_total) change_total, change_type
				from bd_form bf, bd_form_sku bfs
				where bf.apply_no = bfs.apply_no and bf.form_type = 4 and bfs.change_type = 2
                and bf.dispose_result = 1
				<if test="queryMap.q_starttime != null and queryMap.q_starttime != ''">
					and bf.apply_date &gt;= #{queryMap.q_starttime}
				</if>
				<if test="queryMap.q_endtime != null and queryMap.q_endtime != ''">
					and bf.apply_date &lt;= #{queryMap.q_endtime}
				</if>
				group by bf.store_no, bf.store_name, bf.apply_user_no, bf.form_type, bf.destroy_type, bfs.change_type
			) l
			on a.user_no = l.apply_user_no
		) temp, md_store ms
		<include refid="getStockReportCondition"/>
	</select>

	<sql id="getStockReportCondition">
		<where>
			temp.store_no = ms.store_no
			<if test="queryMap.q_storeNo != null and queryMap.q_storeNo !=''">
				and temp.user_no = #{queryMap.q_storeNo}
			</if>
			<if test="queryMap.q_storeNoArr != null and queryMap.q_storeNoArr !=''">
				and temp.user_no in
				<foreach item="storeNo" index="index" collection="queryMap.q_storeNoArr" open="(" separator="," close=")">
					#{storeNo}
				</foreach>
			</if>
			<if test="queryMap.q_brandNo != null and queryMap.q_brandNo !=''">
				and ms.brand_code = (select brand_code from md_brand where brand_no = #{queryMap.q_brandNo})
			</if>
		</where>
	</sql>
</mapper>